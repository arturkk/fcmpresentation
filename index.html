<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Firebase Cloud Messaging (FCM)<</title>

    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/vs.css">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section>
            <h2>Firebase Cloud Messaging (FCM)</h2>
<p></p>
            <p></p>
            <p></p>
<br/>
            <br/>
            <p>Artur Knapczyk</p>

        </section>

        <section>
            <h5>FIREBASE CLOUD MESSAGING (FCM)</h5>
            <p>
                Co to jest:
            </p>
            <p class="fragment">
                Jest to wieloplatformowe rozwiązanie do przesyłania wiadomości, które pozwala niezawodnie dostarczać
                je bez żadnych kosztów. Często z reklamami,
                dodatkowymi funkcjami naszej aplikacji lub zwyczajne powiadomienia o zdarzeniach wynikających z
                biznesowej potrzeby.</p>

        </section>

        <section>

            <p>FCM – jest jedną z usług dostępnych w pakiecie Firebase czyli BaaS (ang. Backend as a Service)</p>
            <table>
                <tr>
                    <td>
                        <ul style="font-size: x-large">
                            <li>Crash reporting</li>
                            <li>Test Lab for Android</li>
                            <li>Performance Monitoring</li>
                            <li>AdMob i AdWords</li>

                        </ul>
                    </td>
                    <td>
                        <ul style="font-size: x-large">
                            <li>Remote Config</li>
                            <li>Realtime Database</li>
                            <li>Authentication</li>
                            <li>Hosting</li>

                        </ul>
                    </td>
                    <td>
                        <ul style="font-size: x-large">
                            <li>Cloud Functions</li>
                            <li>Cloud Storage</li>
                            <li>Google Analytics</li>
                            <li>Invites</li>
                        </ul>
                    </td>
                </tr>
            </table>
        </section>
        <section>
            <h5>RODZAJE WIADOMOŚCI FCM</h5>
            <div class="fragment">
            <table>
                <tr>
                    <td>
                        <ul style="font-size: xx-large">
                            <li><b>Notification message</b> - Wiadomości z powiadomieniami, czasami uważane za
                                „wyświetlanie wiadomości”. Są one obsługiwane automatycznie przez FCM SDK.
                            </li>
                        </ul>
                    </td>


                </tr>
                <tr>
                    <td style="font-size: x-large"><p>Zastosowanie: Reklamy, Alerty pogodowe</p></td>

                </tr>
                <tr>
                    <td></td>
                </tr>
            </table>
            </div>
            <div class="fragment">
        <table>
                <tr>
                    <td>
                        <ul style="font-size: xx-large">
                            <li><b>Data message</b> - wiadomość z danymi do aplikacji <br />tzw. "cichy push"</li>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <td style="font-size: x-large"><p>Zastosowanie: synchronizacja danych na telefonie z serwerem, automatyczne wylogowanie</p> </td>

                </tr>
                <tr>
                    <td></td>
                </tr>

            </table>
            </div>
            <div class="fragment">
            <p>
                Maksymalna wielkość obydwu typów wiadomości to </br> <b>4kb</b>
            </p>
            </div>

        </section>
        <section>
            <p>CO MUSIMY SPEŁNIĆ ŻEBY UŻYWAĆ FCM-A <br />(NA PRZYKŁADZIE ANDROID-A)</p>
            <ul style="font-size: x-large">
                <li class="fragment">Utworzyć projekt na stronie Console firebase</li>
                <br />
                <li class="fragment">W utworzonym projekcie wybranie odpowiedniej platformy (Android, iOS, Aplikacja Sieciowa) </li>
                <br />
                <li class="fragment">Skonfigurować aplikację Android (dodać zależności [biblioteki], dodać plik google-services.json) </li>
                <br />
                <li class="fragment">Pobrać firebase tokena wygenerowanego w aplikacji (identyfikator urządzenia)</li>
                <br />
                <li class="fragment">Przesłać firebase tokena do serwera aplikacji w celu identyfikacji urządzenia</li>
                <br />
                <li class="fragment">Przygotować Serwer aplikacji który będzie wysyłał wiadomości przez API REST</li>
            </ul>

        </section>
    <section>
        <p>SCHEMAT DZIAŁANIA FCM-A</p>
        <table>
            <tr>
                <td><img src="img/image1.gif"></td>
            </tr>
        </table>
    </section>

        <section>
            <p>TWORZYMY PROJEKT FIREBASE</p>
            <p>https://console.firebase.google.com</p>
            <table>
                <tr>
                    <td><img src="img/tworzenie_projektu.png"></td>
                </tr>
            </table>


        </section>
        <section>
            <p>PROJEKT ZOSTAŁ POMYŚLNIE UTWORZONY</p>
            <table>
                <tr>
                    <td><img src="img/utworzony_projekt.png"></td>
                </tr>
            </table>
        </section>
        <section>
            <h5>DODANIE APLIKACJI ANDROID W KONSOLI FIREBASE</h5>
            <table>
                <tr>
                    <td><img src="img/dodanie_aplikacji_androidowej.png"></td>
                </tr>
            </table>

        </section>
        <section>
            <h5>PLIK KONFIGURACYJNY DLA ANDROIDA</h5>
            <table>
                <tr>
                    <td><img src="img/pobierz_plik_google_service_json.png"></td>
                </tr>
            </table>
        </section>
        <section>
            <h5>DODANIE ZALEŻNOŚCI DO ANDROIDA</h5>
            <table>
                <tr>
                    <td><img src="img/dodanie_bibiotek_do_androida.png"></td>
                </tr>
            </table>
        </section>
        <section>
            <h5>FCM - WYMAGANIA NA ANDROIDZIE</h5>
            <ul>
                <li class="fragment">Android 4.1 minium lub wyższy</li>

                <li class="fragment">Zainstalowany sklep Google Play na telefonie</li>
            </ul>

        </section>
        <section>
            <h5>KONFIGURACJA PROJEKTU ANDROID</h5>
            <p style="font-size: medium">Dodajemy go do AndroidManifest.xml </p>

            <pre style="font-size: large">
<code class="hljs xml" data-line-numbers="1-10">
 <service android:name=".service.FirebaseService"
          android:exported="false">
 <intent-filter>
      <action android:name="com.google.firebase.MESSAGING_EVENT" />
 </intent-filter>
</service>

</code>
            </pre>
            <p style="font-size: medium">Tworzymy serwis dziedziczący po FirebaseMessagingService</p>
            <pre style="font-size: medium">
            <code class="hljs java" data-trim data-noescape data-line-numbers="1-20">

    public class FirebaseService extends FirebaseMessagingService {
        @Override
        public void onMessageReceived(RemoteMessage remoteMessage) {
            Map<String, String> data = remoteMessage.getData();
            if (data.size() > 0) {
            try {
                AppTopic topic = AppTopic.valueOf(data.get(TOPIC));
                FirebaseMessageAdapter adapter = topic.getClazz().getConstructor(Context.class).newInstance(getApplicationContext());

            } catch (Exception e) {
                log.error("Could not create adapter for message! Error: {}", e.getMessage());
            }
        }
    }
              </code>
            </pre>
        </section>
        <section>
            <h5>POBIERAMY FIREBASE TOKEN</h5>

            <pre style="font-size: medium">
            <code class="hljs" data-trim data-noescape data-line-numbers="1-20">
public class FirebaseTokenService extends FirebaseInstanceIdService {
    @Override
    public void onTokenRefresh() {
        String token = FirebaseInstanceId.getInstance().getToken();

        UserDetails.setTokenToUpdate(token, getApplicationContext());
        log.info("Firebase token: {}", token);
        String login = UserDetails.getLogin(getApplicationContext());
        if (!StringUtils.isEmpty(login)) {
            FirebaseTokenDto tokenDto = FirebaseTokenDto
                    .builder()
                    .token(token)
                    .login(login)
                    .build();
            firebaseAPI.updateFirebaseToken(tokenDto).enqueue(new UpdateFirebaseTokenCallback(getApplicationContext()));
        }
    }
       </code>
            </pre>
            <p>
                Usuwamy tokena w przypadku wylogowania
            </p>
            <pre style="font-size: medium">
            <code class="hljs java" data-trim data-noescape data-line-numbers="1">
FirebaseInstanceId.getInstance().deleteInstanceId();
            </code>
            </pre>


        </section>
        <section>
            <h5>KIEDY ZMIENIA SIĘ FIREBASE TOKEN?</h5>
            <ul style="font-size: xx-large">
                <li class="fragment">W aplikacji usuniemy instancję ID (np. wylogujemy się z aplikacji)</li>
                <br />
                <li class="fragment">Odinstalujemy lub przeinstalujemy aplikację</li>
                <br />
                <li class="fragment">Użytkownik wyczyści dane aplikacji</li>
            </ul>
        </section>

        <section>
            <p>JAK WYSŁAĆ WIADOMOŚĆ FCM PRZEZ API REST</p>
            <div style="text-align: left">
                <p style="font-size: xx-large">1. Legacy API</p>

                <p style="font-size: xx-large">https://fcm.googleapis.com/fcm/send (POST)</p>

                <pre style="font-size: medium">
							<code class="hljs javascript" data-trim data-noescape data-line-numbers="1-20">
//SEKCJA HEADER
Content-Type:application/json
Authorization:key=AIzaSyZ-1u...0GBYzPu7Udno5aA   //Autoryzacja przez Klucz
project_id=prezentacja-e6dcd
//SEKCJA BODY
// Android
{
  "to" : "ehXfNFNdoMc:APA91bGVp1YrSU2z-U2mk-L8jTR08KFxu-zoWmiH6GW0m6UmMjbdVpHTip.....",
  "data" : {
    "title" : "Unity-t firma",
    "body" : "Alarm rozbrojony",
    "sound" : "default"
  },
  "priority" : "high",   // wybudzenie telefonu jeśli jest w trybie Doze mode
  "time_to_live" : 86400, // czas życia wiadomości
  "content_available" : true
}

</code>
                </pre>
            </div>

        </section>
        <section>
            <p>JAK WYSŁAĆ WIADOMOŚĆ FCM PRZEZ API REST</p>
            <p style="font-size: x-large">2. Nowe API V1 </p>
<p style="font-size: large">https://fcm.googleapis.com/v1/projects/prezentacja-e6dcd/messages:send HTTP/1.1 (POST)</p>
            <pre style="font-size: x-small">
							<code class="hljs javascript" data-trim data-noescape data-line-numbers="1-40">
Content-Type: application/json
Authorization: Bearer ya29.ElqKBGN2Ri_Uz...HnS_uNreA //Autoryzacja przez OAuth2.0
{
  "message": {
    "token": "ehXfNFNdoMc:APA91bGVp1YrSU2z-U2mk-L8jTR08KFxu-zoWmiH6GW0m6UmMjbdVpHTip.....",
    "topic": "news",
    "notification": {
      "title": "Breaking News",
      "body": "New news story available."
    },
    "data": {
      "story_id": "story_12345"
    },
    "android": {
      "notification": {
        "click_action": "TOP_STORY_ACTIVITY",
        "body": "Check out the Top Story"
      }
    },
    "apns": {
      "payload": {
        "aps": {
          "category" : "NEW_MESSAGE_CATEGORY"
        }
      }
    }
  }
}
</code>
                </pre >
              <ul style="font-size: medium">
                <li>W jednym JSON-ie można wysłać komunikaty do różnych platform (iOS, Android, WWW)</li>
                <li>Zabezpiecznie requesta przez (OAuth 2.0 access token)</li>
            </ul>



        </section>
        <section>
            <h5>POPRAWNA ODPOWIEDŹ OD API</h5>
            <pre>
							<code class="hljs javascript" data-trim data-noescape data-line-numbers="1-12">
{
  "success" : 1,
  "failure" : 0,
  "results" : [ {
    "error" : null,
    "message_id" : "0:1557227166700467%12cb6261f9fd7ecd",
    "registration_id" : null
  } ],
  "multicast_id" : "5268891507906885351",
  "canonical_ids" : 0
}

                            </code>
            </pre>

        </section>
    <section>
<h5 style="font-size: xx-large">BŁĘDY KTÓRYCH MOŻEMY SIĘ SPODZIEWAĆ OD API FCM</h5>
        <table border="1" style="font-size: x-large">
            <tr>
                <td>Opis błędu
                </td>
                <td>
Kod HTTP
                </td>
            </tr>
            <tr>
            <td>Missing Registration Token (brak tokena)</td>
            <td>200 + error:MissingRegistration</td>
            </tr>
            <tr>
                <td>Invalid Registration Token (niepoprawny token)</td>
                <td>200 + error:InvalidRegistration</td>
            </tr>
            <tr>
                <td>Unregistered Device</td>
                <td>200 + error:NotRegistered	</td>
            </tr>
            <tr>
                <td>Invalid Package Name</td>
                <td> 200 + error:InvalidPackageName </td>
            </tr>
            <tr>
                <td>Invalid APNs credentials - błąd tylko na iOS</td>
                <td> 200 + error:InvalidApnsCredential
                </td>
            </tr>
            <tr>
                <td>Message Too Big</td>
                <td>200 + error:MessageTooBig
                </td>
            </tr>
            <tr>
                <td>Authentication Error</td>
                <td> 401 </td>
            </tr>
            <tr>
                <td>Invalid JSON</td>
                <td> 400 </td>
            </tr>
            <tr>
                <td>Invalid Parameters</td>
                <td>400 + error:InvalidParameters
                </td>
            </tr>

        </table>
    </section>

        <section>
            <h5>TEST POWIADOMIEŃ Z PLATFORMY CONSOLE FIREBASE</h5>
            <table>
                <tr>
                    <td><img src="img/tworzenie_powiadomienia_z_firebase_consoli.png"></td>
                </tr>
            </table>

        </section>

        <section>
            <h5>TEST POWIADOMIEŃ - WYSYŁANIE WIADOMOŚCI</h5>
            <table>
                <tr>
                    <td><img src="img/wysyłanie_wiadomosci_na_firebase_token.png"></td>
                </tr>
            </table>

        </section>
        <section>
            <h5>PUSH NA TELEFONIE ANDORID / IOS</h5>
            <table>
                <tr>
                    <td><img src="img/android_push.png" style="width: 60%"></td>
                    <td><img src="img/ios_push.jpg" style="width: 60%"></td>
                </tr>
            </table>

        </section>
        <section>
            <h1>DZIĘKUJĘ ZA UWAGĘ</h1>
<p>

</p>
            <p>Artur Knapczyk</p>
            <br />
            <br />
            <img src="img/logo.svg" width="27%" alt="" style="background: #191919; border: 0px"/>


        </section>
        <section>
            <h5>Bibliografia</h5>
            <pre style="font-size: medium">
    • https://logblog.pl/firebase-backend-dla-aplikacji/
    • https://firebase.google.com/?gclid=CjwKCAjw-ZvlBRBbEiwANw9UWkpO7Nqq52duD8WYzJw1JGeJw1-NLpujZjv-M2D23jPJv_6BhJEKYhoCOhoQAvD_BwE
    • https://ekspertsem.pl/google-wprowadza-firebase-narzedzie-analityczne-aplikacji-mobilnych/
    • https://ekspertsem.pl/firebase-remote-config-krok-po-kroku/
    • https://itiq.pl/marketing/czym-firebase-marketing-aplikacji-mobilnych-unity/
    • https://firebase.google.com/pricing/?gclid=CjwKCAjw-ZvlBRBbEiwANw9UWuqcaUXKhkn-iXKp69LL1CHqw3b-OjRHOJ7Ii9DUHy8S-kDTax4EZhoCbTYQAvD_BwE
    • https://firebase.google.com/products/cloud-messaging/
    • https://firebase.google.com/docs/cloud-messaging/concept-options
    • https://firebase.google.com/docs/cloud-messaging/android/
    • https://docs.microsoft.com/pl-pl/xamarin/android/data-cloud/google-messaging/remote-notifications-with-fcm?tabs=windows
    • https://datamobile.wordpress.com/2017/02/14/integracja-aplikacji-android-z-firebase-cloud-messaging/


</pre>
        </section>


    </div>
    <div style="position: absolute; bottom: 0">
        <img  src="img/logo.svg" alt="" width="157.4px" height="49.1px" style="background: #191919"/>
    </div>
</div>

<script src="js/reveal.js"></script>

<script>
    // More info about config & dependencies:
    // - https://github.com/hakimel/reveal.js#configuration
    // - https://github.com/hakimel/reveal.js#dependencies
    Reveal.initialize({
        hash: true,
        controls: true,
        dependencies: [
            {src: 'plugin/markdown/marked.js'},
            {src: 'plugin/markdown/markdown.js'},
            {src: 'plugin/notes/notes.js', async: true},
            {src: 'plugin/highlight/highlight.js', async: true}
        ]
    });
</script>
</body>
</html>
